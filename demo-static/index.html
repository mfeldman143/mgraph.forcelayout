<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>mgraph.forcelayout ES Module Demo</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background: #f0f2f5;
      margin: 0;
    }
    .container { 
      max-width: 1000px; 
      margin: 0 auto; 
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .status { 
      background: white; 
      padding: 15px; 
      border-radius: 8px; 
      margin: 15px 0; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #4CAF50;
    }
    .error { border-left-color: #f44336; }
    .info { border-left-color: #2196F3; }
    
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    svg { 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 4px; 
      cursor: pointer; 
      margin: 5px; 
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .clear-btn { background: #f44336; }
    .clear-btn:hover { background: #da190b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎯 mgraph.forcelayout Demo</h1>
    <div class="status info" id="status">Loading ES module...</div>
    
    <div class="controls">
      <button onclick="runDemo('triangle')">Triangle</button>
      <button onclick="runDemo('square')">Square</button>
      <button onclick="runDemo('star')">Star</button>
      <button onclick="runDemo('grid')">Grid 4x4</button>
      <button onclick="clearGraph()" class="clear-btn">Clear</button>
    </div>
    
    <svg width="900" height="600" id="graph"></svg>
  </div>
  
  <script type="module">
    // Import ES module
    import createLayout from '../dist/mgraph.forcelayout.esm.js';
    
    console.log('✅ createLayout imported:', typeof createLayout);
    
    // Make it globally available for onclick handlers
    window.layoutLib = createLayout;
    
    // Simple graph builder function - make it global
    window.createSimpleGraph = function() {
      const nodes = new Map();
      const links = new Map();
      let linkId = 0;
      const listeners = new Map();
      
      const graph = {
        addNode(id, data = {}) {
          nodes.set(id, { id, data, links: new Set() });
          this.emit('changed', [{ changeType: 'add', node: nodes.get(id) }]);
          return this;
        },
        
        addLink(from, to, data = {}) {
          const id = `link${linkId++}`;
          const link = { id, fromId: from, toId: to, data };
          links.set(id, link);
          
          if (nodes.has(from)) nodes.get(from).links.add(id);
          if (nodes.has(to)) nodes.get(to).links.add(id);
          
          this.emit('changed', [{ changeType: 'add', link }]);
          return this;
        },
        
        getNode: (id) => nodes.get(id),
        getNodesCount: () => nodes.size,
        getLinksCount: () => links.size,
        forEachNode: (cb) => nodes.forEach(cb),
        forEachLink: (cb) => links.forEach(cb),
        
        getLinks(nodeId) {
          const node = nodes.get(nodeId);
          if (!node) return new Set();
          const result = new Set();
          for (const linkId of node.links) {
            result.add(links.get(linkId));
          }
          return result;
        },
        
        hasLink(from, to) {
          for (const link of links.values()) {
            if ((link.fromId === from && link.toId === to) ||
                (link.fromId === to && link.toId === from)) {
              return link;
            }
          }
          return null;
        },
        
        on(event, callback) {
          if (!listeners.has(event)) listeners.set(event, []);
          listeners.get(event).push(callback);
        },
        
        off(event, callback) {
          if (listeners.has(event)) {
            const cbs = listeners.get(event);
            const idx = cbs.indexOf(callback);
            if (idx > -1) cbs.splice(idx, 1);
          }
        },
        
        emit(event, data) {
          if (listeners.has(event)) {
            listeners.get(event).forEach(cb => cb(data));
          }
        }
      };
      
      return graph;
    };
    
    // Renderer - make it global
    window.renderGraph = function(graph, layout) {
      const svg = document.getElementById('graph');
      svg.innerHTML = '';
      
      const rect = layout.getGraphRect();
      const padding = 50;
      const svgW = 900, svgH = 600;
      
      const gw = rect.max_x - rect.min_x || 1;
      const gh = rect.max_y - rect.min_y || 1;
      const scale = Math.min((svgW - 2*padding) / gw, (svgH - 2*padding) / gh, 80);
      
      const ox = svgW/2 - (rect.min_x + gw/2) * scale;
      const oy = svgH/2 - (rect.min_y + gh/2) * scale;
      
      // Draw edges
      graph.forEachLink(link => {
        const from = layout.getNodePosition(link.fromId);
        const to = layout.getNodePosition(link.toId);
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', from.x * scale + ox);
        line.setAttribute('y1', from.y * scale + oy);
        line.setAttribute('x2', to.x * scale + ox);
        line.setAttribute('y2', to.y * scale + oy);
        line.setAttribute('stroke', '#ddd');
        line.setAttribute('stroke-width', '2');
        svg.appendChild(line);
      });
      
      // Draw nodes
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
      graph.forEachNode(node => {
        const pos = layout.getNodePosition(node.id);
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', pos.x * scale + ox);
        circle.setAttribute('cy', pos.y * scale + oy);
        circle.setAttribute('r', 14);
        circle.setAttribute('fill', colors[node.id % colors.length]);
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', pos.x * scale + ox);
        text.setAttribute('y', pos.y * scale + oy + 4);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'white');
        text.setAttribute('font-size', '11');
        text.setAttribute('font-weight', 'bold');
        text.textContent = node.id;
        
        svg.appendChild(circle);
        svg.appendChild(text);
      });
    };
    
    // Update status
    document.getElementById('status').innerHTML = '✅ ES module loaded successfully - Click a button to run demo';
    document.getElementById('status').className = 'status';
  </script>
  
  <script>
    // Global scope functions that can be called by onclick handlers
    
    // Graph generators - now in global scope
    const generators = {
      triangle() {
        return window.createSimpleGraph()
          .addNode(1).addNode(2).addNode(3)
          .addLink(1, 2).addLink(2, 3).addLink(3, 1);
      },
      
      square() {
        return window.createSimpleGraph()
          .addNode(1).addNode(2).addNode(3).addNode(4)
          .addLink(1, 2).addLink(2, 3).addLink(3, 4).addLink(4, 1)
          .addLink(1, 3); // diagonal
      },
      
      star() {
        const graph = window.createSimpleGraph().addNode(0);
        for (let i = 1; i <= 6; i++) {
          graph.addNode(i).addLink(0, i);
        }
        return graph;
      },
      
      grid() {
        const graph = window.createSimpleGraph();
        // 4x4 grid
        for (let i = 0; i < 16; i++) graph.addNode(i);
        
        // Horizontal connections
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 3; col++) {
            graph.addLink(row * 4 + col, row * 4 + col + 1);
          }
        }
        
        // Vertical connections
        for (let row = 0; row < 3; row++) {
          for (let col = 0; col < 4; col++) {
            graph.addLink(row * 4 + col, (row + 1) * 4 + col);
          }
        }
        
        return graph;
      }
    };
    
    function updateStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.className = isError ? 'status error' : 'status';
    }
    
    function runDemo(type) {
      try {
        updateStatus(`Creating ${type} graph...`);
        console.log('Running demo for:', type);
        console.log('Generators available:', Object.keys(generators));
        console.log('layoutLib available:', typeof window.layoutLib);
        
        const graph = generators[type]();
        console.log(`${type}:`, graph.getNodesCount(), 'nodes', graph.getLinksCount(), 'links');
        
        updateStatus('Creating layout...');
        const layout = window.layoutLib(graph, {
          springLength: type === 'grid' ? 30 : 60,
          springCoefficient: 0.8,
          gravity: -12,
          dragCoefficient: 0.9,
          timeStep: 0.5
        });
        
        updateStatus('Running simulation...');
        let steps = 0;
        for (let i = 0; i < 200; i++) {
          layout.step();
          steps++;
        }
        
        updateStatus('Rendering...');
        window.renderGraph(graph, layout);
        
        updateStatus(`✅ ${type}: ${graph.getNodesCount()} nodes, ${steps} steps`);
        
        layout.dispose();
        
      } catch (error) {
        console.error('Error in runDemo:', error);
        updateStatus(`❌ Error: ${error.message}`, true);
      }
    }
    
    function clearGraph() {
      document.getElementById('graph').innerHTML = '';
      updateStatus('Cleared - select a demo');
    }
    
    // Auto-run demo after everything is loaded
    setTimeout(() => {
      console.log('Auto-running triangle demo...');
      runDemo('triangle');
    }, 1000);
  </script>
</body>
</html>